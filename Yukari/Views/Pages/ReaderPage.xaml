<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Yukari.Views.Pages.ReaderPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:Yukari.Helpers.UI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Yukari.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:vmc="using:Yukari.ViewModels.Components"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <Style
            x:Key="TitleBarButtonStyle"
            BasedOn="{StaticResource DefaultButtonStyle}"
            TargetType="Button">
            <Setter Property="Width" Value="40" />
            <Setter Property="Height" Value="36" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="0" />
        </Style>
    </Page.Resources>


    <Grid RowDefinitions="Auto, *">
        <Grid
            x:Name="AppTitleBar"
            Grid.Row="0"
            Height="48"
            Margin="4,0,0,0"
            Padding="0"
            VerticalAlignment="Top"
            AutomationProperties.AutomationId="AppTitleBar"
            ColumnDefinitions="Auto, Auto, Auto, Auto, *, Auto, 144">
            <Grid.Resources>
                <Color x:Key="ButtonBackgroundDisabled">Transparent</Color>
                <Color x:Key="ButtonBorderBrushDisabled">Transparent</Color>
            </Grid.Resources>

            <Button
                Grid.Column="0"
                Command="{Binding GoBackCommand}"
                Content="{ui:FontIcon Glyph=&#xE72B;,
                                      FontSize=11}"
                Style="{StaticResource TitleBarButtonStyle}"
                ToolTipService.ToolTip="Back to Navigation" />
            <FontIcon
                Grid.Column="1"
                Margin="4,0,0,0"
                VerticalAlignment="Center"
                FontSize="20"
                Glyph="&#xE736;" />
            <TextBlock
                Grid.Column="2"
                Margin="10,0,0,0"
                VerticalAlignment="Center"
                Style="{StaticResource CaptionTextBlockStyle}"
                Text="{Binding ComicTitle}" />
            <TextBlock
                Grid.Column="3"
                Margin="8,0,0,0"
                VerticalAlignment="Center"
                FontSize="10"
                Foreground="{StaticResource TextFillColorSecondaryBrush}"
                Text="{Binding ChapterTitle}" />
            <StackPanel
                Grid.Column="5"
                Margin="4,0,4,0"
                Orientation="Horizontal"
                Spacing="4">

                <Button
                    Command="{Binding PreviousChapterCommand}"
                    Content="{ui:FontIcon Glyph=&#xE76B;}"
                    Style="{StaticResource TitleBarButtonStyle}"
                    ToolTipService.ToolTip="Previous Chapter" />

                <Button
                    Command="{Binding NextChapterCommand}"
                    Content="{ui:FontIcon Glyph=&#xE76C;}"
                    Style="{StaticResource TitleBarButtonStyle}"
                    ToolTipService.ToolTip="Next Chapter" />

                <AppBarSeparator Grid.Column="6" />

                <Button
                    Content="{ui:FontIcon Glyph=&#xE740;,
                                          FontSize=16}"
                    Style="{StaticResource TitleBarButtonStyle}"
                    ToolTipService.ToolTip="Fullscreen" />
                <Button
                    Content="{ui:FontIcon Glyph=&#xE712;}"
                    Style="{StaticResource TitleBarButtonStyle}"
                    ToolTipService.ToolTip="Options" />

                <AppBarSeparator Grid.Column="6" />
            </StackPanel>

        </Grid>

        <Grid Grid.Row="1">
            <FlipView
                x:Name="PagesFlipView"
                Background="Transparent"
                FlowDirection="RightToLeft"
                ItemsSource="{Binding ChapterPages}">
                <FlipView.ItemTemplate>
                    <DataTemplate x:DataType="vmc:ChapterPageItemViewModel">
                        <ScrollViewer
                            x:Name="PageScrollViewer"
                            FlowDirection="LeftToRight"
                            HorizontalScrollBarVisibility="Auto"
                            HorizontalScrollMode="Auto"
                            MinZoomFactor="1"
                            PointerEntered="PageScrollViewer_PointerEntered"
                            PointerExited="PageScrollViewer_PointerExited"
                            PointerMoved="PageScrollViewer_PointerMoved"
                            PointerPressed="PageScrollViewer_PointerPressed"
                            PointerReleased="PageScrollViewer_PointerReleased"
                            VerticalScrollBarVisibility="Auto"
                            VerticalScrollMode="Auto"
                            ViewChanged="PageScrollViewer_ViewChanged"
                            ZoomMode="Enabled">

                            <Grid
                                MaxWidth="{Binding ElementName=PageScrollViewer, Path=ViewportWidth}"
                                MaxHeight="{Binding ElementName=PageScrollViewer, Path=ViewportHeight}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">

                                <ProgressRing
                                    Width="45"
                                    Height="45"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    IsIndeterminate="True"
                                    Visibility="{x:Bind IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, Mode=OneWay}" />

                                <StackPanel
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="10"
                                    Visibility="{x:Bind HasError, Converter={StaticResource BooleanToVisibilityConverter}, Mode=OneWay}">
                                    <FontIcon
                                        HorizontalAlignment="Center"
                                        FontSize="40"
                                        Foreground="{StaticResource SystemFillColorCriticalBrush}"
                                        Glyph="&#xEB90;" />
                                    <TextBlock
                                        HorizontalAlignment="Center"
                                        Style="{StaticResource BodyStrongTextBlockStyle}"
                                        Text="Failed to load page" />
                                    <Button HorizontalAlignment="Center" Command="{x:Bind RetryCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontSize="16" Glyph="&#xE72C;" />
                                            <TextBlock Text="Try Again" />
                                        </StackPanel>
                                    </Button>
                                </StackPanel>

                                <Image
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    ImageFailed="Page_ImageFailed"
                                    ImageOpened="Page_ImageOpened"
                                    Source="{Binding ImageUrl}"
                                    Stretch="Uniform"
                                    Visibility="{x:Bind HasError, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert, Mode=OneWay}" />

                            </Grid>
                        </ScrollViewer>
                    </DataTemplate>
                </FlipView.ItemTemplate>
            </FlipView>
        </Grid>
    </Grid>
</Page>
